pr: none
trigger:
  branches:
    include:
      - '*'

variables:
  - group: integration-iac-deployment-settings
  - name: dockerfilePath
    value: '$(Pipeline.Workspace)/github/AzDockerfile'
  - name: pomFile
    value: '$(Pipeline.Workspace)/github/pom.xml'
  - name: appName
    value: integral-mecenat-old-ref
  - name: imageName
    value: integral-mecenat-old
  - name: tag
    value: '${BUILD_BUILDNUMBER}_${BUILD_SOURCEVERSION:0:8}'
  - name: parametersFileName
    value: ref.parameters.json

resources:
  repositories:
    - repository: cet-iac
      type: git
      name: Cloud Excellence Team/cet-iac
      ref: main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self
    path: github

  - task: MavenAuthenticate@0
    displayName: Authenticate to Artifact feed 
    inputs:
      artifactsFeeds: 'integration'

  - task: Maven@3
    name: 'BuildPackage'
    displayName: Package artifact
    inputs:
      mavenPomFile: $(pomFile)
      goals: 'clean package'
      options: '--no-transfer-progress'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.11'
      mavenVersionOption: 'Default'
      mavenAuthenticateFeed: false
      effectivePomSkip: false

  - template: templates/docker/build.yml@cet-iac
    parameters:
      runScan: false
      checkoutRepo: false
      dockerFilePath: $(dockerfilePath)
      imageName: $(imageName)
      tag: $(tag)

  - template: templates/docker/push.yml@cet-iac
    parameters:
      dockerFilePath: $(dockerfilePath)
      checkoutRepo: false
      imageName: $(imageName)
      tag: $(tag)

  - template: templates/app-service/update-image.yml@cet-iac
    parameters:
      parametersFileName: $(parametersFileName)
      appName: $(appName)
      imageName: $(imageName)
      tag: $(tag)
      isApi: false
      hasSlot: false
